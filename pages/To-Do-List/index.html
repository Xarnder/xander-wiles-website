<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Task Master</title>

    <!-- Theme-aware SVG icons -->
    <link rel="icon" href="favicon.ico" sizes="any">
    <link rel="icon" href="favicon-light.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
    <link rel="icon" href="favicon-dark.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="manifest" href="site.webmanifest">

    <!-- Global Header -->
    <link rel="stylesheet" href="/assets/css/style.css">

    <!-- App Styles -->
    <link rel="stylesheet" href="style.css">

    <!-- SortableJS & Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>

<body>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay">
        <h1>Task Master</h1>
        <button id="google-login-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="24" height="24"
                alt="G">
            Login with Google
        </button>
    </div>

    <!-- GLOBAL HEADER PLACEHOLDER -->
    <div id="main-nav-placeholder"></div>
    <script src="/assets/js/nav-loader.js"></script>

    <!-- APP CONTAINER -->
    <div class="app-wrapper">
        <header class="app-header glass-panel">
            <div class="header-left">
                <input type="text" id="project-title-input" class="project-title-input" value="Task Master"
                    placeholder="Project Name">
                <span id="total-task-count" class="total-count-badge"></span>
            </div>

            <div class="header-controls">
                <!-- Search Button -->
                <button id="search-btn" class="icon-btn-large control-item" title="Search Tasks">
                    <i class="ph ph-magnifying-glass"></i>
                </button>

                <!-- Search Lists Button -->
                <button id="search-list-btn" class="icon-btn-large control-item" title="Search Lists">
                    <i class="ph ph-list-magnifying-glass"></i>
                </button>

                <div class="sort-container control-item">
                    <label for="sort-select"><i class="ph ph-sort-ascending"></i></label>
                    <select id="sort-select" class="glass-select">
                        <option value="custom">Custom</option>
                        <option value="alphabetical">A-Z</option>
                        <option value="newest">Newest</option>
                        <option value="oldest">Oldest</option>
                    </select>
                </div>

                <div class="toggle-group control-item" title="Drag Mode">
                    <span class="label">Drag:</span>
                    <button id="mode-cut-btn" class="mode-btn active">Cut</button>
                    <button id="mode-copy-btn" class="mode-btn">Copy</button>
                </div>

                <button id="multi-edit-btn" class="btn secondary control-item" title="Toggle Multi-Edit Mode">
                    <i class="ph ph-checks"></i> Multi
                </button>

                <button id="toggle-archive-view-btn" class="icon-btn-large control-item"
                    title="Show/Hide Archived Tasks">
                    <i class="ph ph-eye-slash" id="archive-view-icon"></i>
                </button>

                <button id="theme-toggle" class="icon-btn-large control-item" title="Toggle Theme">
                    <i class="ph ph-sun"></i>
                </button>

                <button id="add-list-btn" class="btn primary control-item">+ List</button>

                <button id="options-btn" class="btn secondary control-item">Options</button>
                <button id="logout-btn" class="btn secondary control-item"
                    style="display:none; color: var(--accent-red); border-color: var(--accent-red);">Logout</button>
            </div>
        </header>

        <main id="board-container" class="board-container">
            <!-- Lists injected here -->
        </main>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="hidden-image-input" accept="image/*" style="display: none;">

    <!-- OPTIONS MODAL -->
    <div id="options-modal-overlay" class="modal-overlay hidden">
        <div class="modal glass-panel">
            <div class="modal-header-row">
                <h2>App Options</h2>
                <button id="close-options-btn" class="icon-btn-large">&times;</button>
            </div>
            <div class="options-list">
                <label class="dropdown-item-toggle">
                    <span>Show Task Numbers</span>
                    <div class="switch-small">
                        <input type="checkbox" id="show-numbers-toggle">
                        <span class="slider-small round"></span>
                    </div>
                </label>
                <label class="dropdown-item-toggle">
                    <span>Auto-Archive Completed</span>
                    <div class="switch-small">
                        <input type="checkbox" id="auto-archive-toggle">
                        <span class="slider-small round"></span>
                    </div>
                </label>
                <label class="dropdown-item-toggle">
                    <span>New Tasks at Bottom</span>
                    <div class="switch-small">
                        <input type="checkbox" id="add-bottom-toggle">
                        <span class="slider-small round"></span>
                    </div>
                </label>
                <hr class="dropdown-divider">

                <!-- IMPORT / EXPORT -->
                <button id="download-json-btn" class="menu-action-item"><i class="ph ph-download-simple"></i> Download
                    Backup</button>
                <label for="upload-json" class="menu-action-item"><i class="ph ph-upload-simple"></i> Restore
                    Backup</label>
                <input type="file" id="upload-json" accept=".json" style="display: none;">

                <!-- TODOIST IMPORT (NEW) -->
                <label for="import-todoist-csv" class="menu-action-item" style="color: #e44332;">
                    <i class="ph ph-file-csv"></i> Import Todoist CSV
                </label>
                <input type="file" id="import-todoist-csv" accept=".csv" style="display: none;">

                <hr class="dropdown-divider">
                <div class="menu-action-item" style="cursor: default; padding-right: 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span><i class="ph ph-bell-ringing"></i> Backup Reminder</span>
                        <input type="number" id="backup-frequency-input" value="10" min="1" max="1000"
                            style="width: 60px; padding: 4px; border-radius: 4px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.2); color: var(--text-primary); text-align: center;">
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">Current Count: <span
                            id="tasks-since-backup-display">0</span></div>
                </div>

                <hr class="dropdown-divider">
                <button id="trigger-reset-btn" class="menu-action-item danger-text"><i class="ph ph-trash"></i> Reset
                    App Data</button>
            </div>
        </div>
    </div>

    <!-- BULK ADD MODAL -->
    <div id="bulk-add-modal-overlay" class="modal-overlay hidden">
        <div class="modal glass-panel">
            <h2>Bulk Add Tasks</h2>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">
                Paste your list below. Each new line will become a separate task.
            </p>
            <textarea id="bulk-add-input" rows="8" placeholder="Task 1&#10;Task 2..."></textarea>
            <div class="modal-actions-bar">
                <button id="bulk-add-confirm-btn" class="btn primary">Add Tasks</button>
                <button id="bulk-add-close-btn" class="btn secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- SEARCH MODAL -->
    <div id="search-modal-overlay" class="modal-overlay hidden">
        <div class="modal glass-panel" style="max-height: 90vh;">
            <div class="modal-header-row">
                <h2>Search Tasks</h2>
                <button id="close-search-btn" class="icon-btn-large">&times;</button>
            </div>
            <input type="text" id="search-input" class="add-task-input" placeholder="Type to search..."
                style="margin-bottom: 15px; font-size: 1.1rem; padding: 12px;">
            <div id="search-results-container" class="task-list" style="overflow-y: auto; max-height: 60vh;">
                <!-- Results injected here -->
            </div>
            <div id="search-empty-state" class="hidden"
                style="text-align: center; color: var(--text-secondary); padding: 20px;">
                <i class="ph ph-magnifying-glass" style="font-size: 3rem; opacity: 0.5; margin-bottom: 10px;"></i>
                <p>No tasks found.</p>
            </div>
        </div>
    </div>

    <!-- SEARCH LIST MODAL -->
    <div id="search-list-modal-overlay" class="modal-overlay hidden">
        <div class="modal glass-panel">
            <div class="modal-header-row">
                <h2>Search Lists</h2>
                <button id="close-search-list-btn" class="icon-btn-large">&times;</button>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">
                Type a list name. Matching lists will be moved to the start of the board.
            </p>
            <input type="text" id="search-list-input" class="add-task-input" placeholder="List Name..."
                style="font-size: 1.1rem; padding: 12px; margin-bottom: 10px;">

            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="view-reordered-btn" class="btn primary">View Reordered Lists</button>
                <button id="clear-list-search-btn" class="btn secondary">Clear & Close</button>
            </div>
        </div>
    </div>

    <!-- EDIT TASK MODAL -->
    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal glass-panel">
            <h2>Edit Task</h2>
            <textarea id="modal-task-input" rows="4" placeholder="Task description..."></textarea>

            <!-- GLOW COLOR PICKER -->
            <div class="color-picker-section">
                <h3>Card Glow Effect:</h3>
                <div class="color-options" id="glow-color-options">
                    <button class="color-btn" data-color="none" title="None"><i class="ph ph-prohibit"></i></button>
                    <button class="color-btn" data-color="#ef4444" style="background:#ef4444;"></button> <!-- Red -->
                    <button class="color-btn" data-color="#f97316" style="background:#f97316;"></button> <!-- Orange -->
                    <button class="color-btn" data-color="#eab308" style="background:#eab308;"></button> <!-- Yellow -->
                    <button class="color-btn" data-color="#22c55e" style="background:#22c55e;"></button> <!-- Green -->
                    <button class="color-btn" data-color="#3b82f6" style="background:#3b82f6;"></button> <!-- Blue -->
                    <button class="color-btn" data-color="#a855f7" style="background:#a855f7;"></button> <!-- Purple -->
                </div>
            </div>

            <div class="modal-actions-bar">
                <button id="modal-save-btn" class="btn primary">Save Changes</button>
                <button id="modal-close-btn" class="btn secondary">Close</button>
            </div>

            <div class="modal-divider"></div>
            <div class="manual-move-section">
                <h3>Currently In:</h3>
                <div id="current-locations-list" class="current-locations-list"></div>

                <h3>Add to another List:</h3>
                <div class="move-controls">
                    <select id="manual-move-select" class="glass-select full-width">
                        <option value="" disabled selected>Select Destination...</option>
                    </select>
                    <div class="move-buttons">
                        <button id="manual-link-btn" class="btn secondary">Link (Copy)</button>
                        <button id="manual-move-btn" class="btn secondary">Move (Cut)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MULTI EDIT ACTIONS MODAL -->
    <div id="multi-edit-modal-overlay" class="modal-overlay hidden">
        <div class="modal glass-panel">
            <div class="modal-header-row">
                <h2 id="multi-edit-title">Edit Selected Tasks</h2>
                <button id="multi-edit-close-modal-btn" class="icon-btn-large">&times;</button>
            </div>

            <div class="color-picker-section">
                <h3>Set Color for All:</h3>
                <div class="color-options" id="multi-glow-color-options">
                    <!-- Same colors as single edit -->
                    <button class="color-btn" data-color="none" title="None"><i class="ph ph-prohibit"></i></button>
                    <button class="color-btn" data-color="#ef4444" style="background:#ef4444;"></button>
                    <button class="color-btn" data-color="#f97316" style="background:#f97316;"></button>
                    <button class="color-btn" data-color="#eab308" style="background:#eab308;"></button>
                    <button class="color-btn" data-color="#22c55e" style="background:#22c55e;"></button>
                    <button class="color-btn" data-color="#3b82f6" style="background:#3b82f6;"></button>
                    <button class="color-btn" data-color="#a855f7" style="background:#a855f7;"></button>
                </div>
            </div>

            <div class="modal-divider"></div>

            <div class="manual-move-section">
                <h3>Batch Move / Copy:</h3>
                <p style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:10px;">
                    Select a destination list or create a new one.
                </p>
                <div class="move-controls">
                    <select id="multi-move-select" class="glass-select full-width">
                        <option value="" disabled selected>Select Destination...</option>
                    </select>
                    <div class="move-buttons">
                        <button id="multi-link-btn" class="btn secondary">Link (Copy)</button>
                        <button id="multi-move-btn" class="btn secondary">Move (Cut)</button>
                    </div>
                </div>
            </div>

            <div class="modal-actions-bar" style="margin-top: 15px;">
                <button id="multi-delete-btn" class="btn danger" style="margin-right: auto;">Delete All</button>
                <button id="multi-close-btn" class="btn secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Floating Action Button for Multi Edit -->
    <div id="multi-edit-floating-bar" class="floating-action-bar hidden">
        <span id="multi-selected-count">0 Selected</span>
        <button id="multi-edit-action-btn" class="btn primary">Edit Selected</button>
    </div>

    <!-- Image Lightbox -->
    <div id="image-modal-overlay" class="modal-overlay hidden" style="background: rgba(0,0,0,0.95);">
        <div class="image-modal-content">
            <button id="image-modal-close" class="icon-btn-large"
                style="position: absolute; top: 20px; right: 20px; color: white; z-index: 2000;">&times;</button>
            <img id="full-size-image" src="" alt="Full view">
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast hidden">
        <i class="ph ph-warning"></i>
        <span id="toast-message"></span>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal-overlay" class="modal-overlay hidden">
        <div class="modal glass-panel confirm-box">
            <div class="confirm-icon-area"><i class="ph ph-warning-circle"></i></div>
            <h2 id="confirm-title">Are you sure?</h2>
            <p id="confirm-desc">This action cannot be undone.</p>
            <div class="modal-actions centered-actions">
                <button id="confirm-cancel-btn" class="btn secondary">Cancel</button>
                <button id="confirm-yes-btn" class="btn danger">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Reset Slider -->
    <div id="reset-modal-overlay" class="modal-overlay hidden">
        <div class="modal glass-panel confirm-box">
            <div class="confirm-icon-area" style="color: var(--accent-red);"><i class="ph ph-skull"></i></div>
            <h2>Reset Everything?</h2>
            <p>Delete all lists, tasks, and images.</p>
            <p id="backup-reminder" class="backup-reminder"><i class="ph ph-warning"></i> You must download a backup
                first.</p>
            <button id="reset-download-backup-btn" class="btn secondary" style="width: 100%; margin-bottom: 10px;">
                <i class="ph ph-download-simple"></i> Download Backup
            </button>
            <div class="slider-container disabled" id="slider-container">
                <div class="slider-track"><span class="slider-text">Download backup first</span></div>
                <div class="slider-handle" id="slider-handle"><i class="ph ph-caret-right"></i></div>
            </div>
            <button id="reset-cancel-btn" class="btn secondary" style="margin-top: 15px; width: 100%;">Cancel</button>
        </div>
    </div>

    <!-- BACKUP REMINDER MODAL -->
    <div id="backup-reminder-modal-overlay" class="modal-overlay hidden">
        <div class="modal glass-panel confirm-box">
            <div class="confirm-icon-area" style="color: var(--accent-yellow);"><i class="ph ph-warning"></i></div>
            <h2>Backup Reminder</h2>
            <p>You've added quite a few tasks! <br> Would you like to download a manual backup?</p>
            <div class="modal-actions centered-actions"
                style="display: flex; flex-direction: column; gap: 20px; width: 100%;">
                <button id="reminder-download-btn" class="btn primary" style="width: 100%;">
                    <i class="ph ph-download-simple"></i> Download JSON Backup
                </button>
                <button id="reminder-skip-btn" class="btn secondary" style="width: 100%;">
                    No thanks, I will risk it
                </button>
            </div>
        </div>
    </div>

    <!-- Sync Indicator -->
    <div id="sync-console" class="sync-indicator hidden">
        <div class="sync-pill glass-panel">
            <div id="sync-dot" class="sync-dot"></div>
            <span id="sync-status-text">Synced</span>
        </div>
    </div>

    <script type="module" src="app.js"></script>
</body>

</html>