<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Custom MIDI Editor</title>

    <!-- Theme-aware SVG icons -->
    <link rel="icon" href="favicon.ico" sizes="any">
    <link rel="icon" href="favicon-light.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
    <link rel="icon" href="favicon-dark.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">

    <!-- Fallback PNG icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">

    <link rel="manifest" href="site.webmanifest">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#111115" media="(prefers-color-scheme: dark)">

    <!-- Global Website Header -->
    <link rel="stylesheet" href="/assets/css/style.css">

    <!-- Local Page Styles -->
    <link rel="stylesheet" href="style.css">

    <!-- External Libraries (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
</head>

<body>

    <!-- Global Header Placeholder -->
    <div id="main-nav-placeholder"></div>
    <script src="/assets/js/nav-loader.js"></script>

    <div class="app-container">

        <header class="app-header">
            <h1>MIDI Studio & Sampler</h1>
            <p>Upload a sound, tune it, and play your MIDI files.</p>
        </header>

        <!-- Status Log -->
        <div id="status-log" class="card status-card">
            Status: Ready.
        </div>

        <div class="grid-layout">

            <!-- Card 1: Instrument Setup -->
            <div class="card control-panel">
                <h2>1. Instrument Setup</h2>

                <div class="input-group">
                    <label for="audioFile">Upload Sample (MP3/WAV)</label>
                    <input type="file" id="audioFile" accept="audio/mp3, audio/wav, audio/mpeg">
                </div>

                <div class="tuning-assistant hidden" id="tuning-interface">
                    <div class="compare-row">
                        <button id="playRawBtn" class="btn secondary small-btn">Play Original</button>
                        <button id="autoDetectBtn" class="btn accent small-btn">Auto-Detect Pitch</button>
                    </div>

                    <label>Manual Tuning / Reference Piano:</label>
                    <div class="octave-control">
                        <span>Octave:</span>
                        <button id="octaveDown" class="btn-round">-</button>
                        <span id="currentOctaveDisplay">4</span>
                        <button id="octaveUp" class="btn-round">+</button>
                    </div>

                    <div class="piano-keys" id="pianoContainer">
                        <!-- Keys generated by JS -->
                    </div>
                    <p class="small-text">Click a key to play a reference tone and set it as the Root Note.</p>
                </div>

                <div class="tuning-controls">
                    <label for="rootNote">Selected Root Note:</label>
                    <select id="rootNote">
                        <!-- Filled by JS -->
                    </select>
                </div>

                <button id="testAudioBtn" class="btn secondary">Test Sampler (Plays Middle C)</button>
            </div>

            <!-- Card 2: MIDI Setup -->
            <div class="card control-panel">
                <h2>2. MIDI Loader</h2>

                <div class="input-group">
                    <label for="midiFile">Upload .MID File</label>
                    <input type="file" id="midiFile" accept=".mid, .midi">
                </div>

                <div class="playback-controls">
                    <button id="playBtn" class="btn primary" disabled>Play MIDI</button>
                    <button id="stopBtn" class="btn danger" disabled>Stop</button>
                </div>
            </div>

        </div>

        <!-- Card 3: Visualizer -->
        <div class="card visualizer-card">
            <div class="visualizer-header">
                <h2>Track Visualization</h2>

                <div class="playback-controls-permanent">
                    <button id="permRewindBtn" class="btn-round" title="Rewind to Start">⏮</button>
                    <button id="permPlayBtn" class="btn-round large" title="Play/Pause">▶</button>
                    <button id="permStopBtn" class="btn-round" title="Stop">⏹</button>
                </div>

                <div class="track-controls">
                    <div class="octave-adjust">
                        <span>Pitch:</span>
                        <button id="shiftDown" class="btn-round small">-</button>
                        <span id="shiftDisplay">0</span>
                        <button id="shiftUp" class="btn-round small">+</button>
                    </div>
                    <select id="exportFormat" class="small-select">
                        <option value="wav">WAV</option>
                        <option value="mp3">MP3</option>
                    </select>
                    <button id="downloadBtn" class="btn secondary small-btn">Download</button>
                </div>
            </div>

            <div class="canvas-container">
                <canvas id="keysCanvas"></canvas>
                <div class="canvas-wrapper" id="canvasWrapper">
                    <canvas id="midiCanvas"></canvas>
                    <!-- Overlay button kept as initial starter -->
                    <div id="overlayPlayBtn" class="overlay-play-btn hidden">
                        <svg viewBox="0 0 24 24" width="48" height="48">
                            <path fill="currentColor" d="M8 5v14l11-7z" />
                        </svg>
                    </div>
                    <div id="playHead" class="play-head"></div>
                </div>
            </div>
            <div id="file-info">No MIDI loaded</div>
        </div>

    </div>

    <script src="script.js"></script>
</body>

</html>